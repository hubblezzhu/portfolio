---
layout: post
title: net protocol ARP
date: 2024-08-02 16:40:13
description:
tags: net-protocol ARP
categories: net-protocol
---

ARP 协议

## 什么是ARP？

ARP（Address Resolution Protocol，地址解析协议）是用来将IP地址解析为MAC地址的协议。主机或三层网络设备上会维护一张ARP表，用于存储IP地址和MAC地址的映射关系，一般ARP表项包括动态ARP表项和静态ARP表项。

## 为什么需要ARP

在局域网中，当主机或其它三层网络设备有数据要发送给另一台主机或三层网络设备时，需要知道对方的网络层地址（即IP地址）。但是仅有IP地址是不够的，因为IP报文必须封装成帧才能通过物理网络发送，因此发送方还需要知道接收方的物理地址（即MAC地址），这就需要一个通过IP地址获取物理地址的协议，以完成从IP地址到MAC地址的映射。地址解析协议ARP即可实现将IP地址解析为MAC地址。

## ARP有哪些类型

### 动态ARP

动态ARP表项由ARP协议通过ARP报文自动生成和维护，可以被老化，可以被新的ARP报文更新，也可以被静态ARP表项覆盖。

动态ARP适用于拓扑结构复杂、通信实时性要求高的网络。

### 静态ARP

静态ARP表项是由网络管理员手工建立的IP地址和MAC地址之间固定的映射关系。静态ARP表项不会被老化，不会被动态ARP表项覆盖。

正常情况下网络中设备可以通过ARP协议进行ARP表项的动态学习，生成的动态ARP表项可以被老化，可以被更新。但是当网络中存在ARP攻击时，设备中动态ARP表项可能会被更新成错误的ARP表项，或者被老化，造成合法用户通信异常。

静态ARP表项不会被老化，也不会被动态ARP表项覆盖，可以保证网络通信的安全性。静态ARP表项可以限制本端设备和指定IP地址的对端设备通信时只使用指定的MAC地址，此时攻击报文无法修改本端设备的ARP表中IP地址和MAC地址的映射关系，从而保护了本端设备和对端设备间的正常通信。一般在网关设备上配置静态ARP表项。

静态ARP表项分为短静态ARP表项和长静态ARP表项。

短静态ARP表项：手工建立IP地址和MAC地址之间固定的映射关系，未同时指定VLAN和出接口。
如果出接口是处于二层模式的以太网接口，短静态ARP表项不能直接用于报文转发。当需要发送报文时，设备会先发送ARP请求报文，如果收到的ARP应答报文中的源IP地址和源MAC地址与所配置的IP地址和MAC地址相同，则将收到ARP应答报文的VLAN和接口加入该静态ARP表项中，后续设备可直接用该静态ARP表项转发报文。

长静态ARP表项：手工建立IP地址和MAC地址之间固定的映射关系，并同时指定该ARP表项所在VLAN和出接口。
长静态ARP表项可以直接用于报文转发。建议用户采用长静态ARP表项。

### 免费ARP

设备主动使用自己的IP地址作为目的IP地址发送ARP请求，此种方式称免费ARP。

免费ARP有如下作用：

- IP地址冲突检测：当设备接口的协议状态变为Up时，设备主动对外发送免费ARP报文。正常情况下不会收到ARP应答，如果收到，则表明本网络中存在与自身IP地址重复的地址。如果检测到IP地址冲突，设备会周期性的广播发送免费ARP应答报文，直到冲突解除。
- 用于通告一个新的MAC地址：发送方更换了网卡，MAC地址变化了，为了能够在动态ARP表项老化前通告网络中其他设备，发送方可以发送一个免费ARP。
- 在VRRP备份组中用来通告主备发生变换：发生主备变换后，MASTER设备会广播发送一个免费ARP报文来通告发生了主备变换。

### Proxy ARP

如果ARP请求是从一个网络的主机发往同一网段但不在同一物理网络上的另一台主机，那么连接这两个网络的设备就可以回答该ARP请求，这个过程称作ARP代理(Proxy ARP)。

Proxy ARP有以下特点：

- Proxy ARP部署在网关上，网络中的主机不必做任何改动。
- Proxy ARP可以隐藏物理网络细节，使两个物理网络可以使用同一个网络号。
- Proxy ARP只影响主机的ARP表，对网关的ARP表和路由表没有影响。
- Proxy ARP分为路由式Proxy ARP、VLAN内Proxy ARP和VLAN间Proxy ARP。

### ARP老化

如上图中所示，如果每次Host_1和Host_3通信前都要发送一个广播的ARP请求报文，会极大的增加网络负担。而且同广播域的所有设备都需要接收和处理这个广播的ARP请求报文，也极大的影响了网络中设备的运行效率。为了解决以上问题，每台主机或设备上都维护着一个高速缓存，这是ARP高效运行的一个关键。在这个高速缓存中，存放主机或设备最近学习到的IP地址到MAC地址的映射关系，即动态ARP表项。

主机或设备每次发送报文时，会先在本地高速缓存中查找目的IP地址所对应的MAC地址。如果高速缓存中有对应的MAC地址，主机或设备不会再发送ARP请求报文，而是直接将报文发至这个MAC地址；如果高速缓存中没有对应的MAC地址，主机或设备才会广播发送ARP请求报文，进行ARP地址解析。

一方面由于高速缓存的容量限制，另一方面为了保证高速缓存中ARP表项的准确性，设备会对动态ARP表项进行老化和更新。

动态ARP表项的老化参数有：老化超时时间、老化探测次数和老化探测模式。设备上动态ARP表项到达老化超时时间后，设备会发送老化探测报文（即ARP请求报文），如果能收到ARP应答报文，则更新该动态ARP表项，本次老化探测结束；如果超过设置的老化探测次数后仍没有收到ARP应答报文，则删除该动态ARP表项，本次老化探测结束。

设备发送的老化探测报文可以是单播报文，也可以是广播报文。缺省情况下，设备只在最后一次发送ARP老化探测报文是广播模式，其余均为单播模式发送。当对端设备MAC地址不变时，可以配置接口以单播模式发送ARP老化探测报文。

当接口Down时设备会立即删除相应的动态ARP表项。

## 华为 ARP 协议介绍

https://info.support.huawei.com/info-finder/encyclopedia/zh/ARP.html


## ARP 协议的过程
1. 发送ARP请求（ARP Request）
当主机A想要和主机B通信时，主机A需要知道主机B的MAC地址。假设主机A知道主机B的IP地址，但不知道其MAC地址。此时，主机A会在局域网中广播一个ARP请求。ARP请求的内容包括：

发送方的IP地址和MAC地址（主机A）
目标的IP地址（主机B）
目标的MAC地址（此时为空）
这个ARP请求是以广播形式发送的，意味着网络中的所有设备都会接收到这个请求。

2. 接收ARP请求
局域网中的所有设备接收到ARP请求后，会检查请求中的目标IP地址是否与自己的IP地址匹配：

如果设备的IP地址与请求中的目标IP地址匹配（比如主机B），则该设备会进行回应。
如果设备的IP地址不匹配，则丢弃这个ARP请求。
3. 发送ARP响应（ARP Reply）
如果主机B的IP地址与请求中的目标IP地址匹配，那么主机B会发送一个ARP响应包给主机A，内容包括：

目标IP地址（主机A的IP地址）
目标MAC地址（主机A的MAC地址）
发送方的IP地址和MAC地址（主机B的IP地址和MAC地址）
这个ARP响应包是单播的，直接发给主机A。

4. 主机A接收ARP响应并更新ARP缓存
主机A接收到主机B的ARP响应后，会提取其中的主机B的MAC地址，并将其与主机B的IP地址对应存储在本地的ARP缓存（ARP Cache）中。这样，当主机A再次与主机B通信时，就可以直接从缓存中获取主机B的MAC地址，而无需再次发送ARP请求。

5. ARP缓存超时与更新
ARP缓存中的条目通常都有一个超时时间（例如几分钟）。当某个条目过期后，如果主机A还需要和主机B通信，ARP过程会再次发生。

## Question

#### 1、ARP 冲突的情况
1、IP地址冲突：多个设备使用了相同的IP地址。这可能是因为手动配置错误，或者DHCP服务器分配了重复的IP地址。
2、ARP欺骗：某些设备（如攻击者）故意伪造ARP响应，试图冒充目标设备。这种攻击被称为ARP欺骗攻击或中间人攻击（Man-in-the-Middle Attack）。

解决方式主要是IP地址冲突检测
